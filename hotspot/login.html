<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="-1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Internet hotspot - Log in</title>
    <link rel="stylesheet" href="css/style.css">
    <script>
        // Get organization ID from URL parameter or set a default
        function getOrgId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('org') || '67ed1d0dfa4861088cfcb6a0';
        }

        // Get base API URL
        function getApiUrl() {
            // If running locally, use the devtunnel URL
            if (window.location.protocol === 'file:') {
                return 'https://w06z1rvh-80.inc1.devtunnels.ms';
            }
            // Otherwise use relative URL
            return '';
        }

        // Fetch packages from API with better error handling
        async function fetchPackages() {
            const orgId = getOrgId();
            const apiUrl = `${getApiUrl()}/api/hotspot/packages?organization_id=${orgId}`;
            
            console.log('Fetching packages from:', apiUrl);
            
            try {
                window.packagesLoaded = false;
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Received package data:', data);

                window.packagesLoaded = true;
                if (data && data.packages && data.packages.length > 0) {
                    displayPackages(data.packages);
                } else {
                    useLocalPackages();
                }
            } catch (error) {
                console.error('Fetch error:', error);
                useLocalPackages();
            }
        }

        // Display packages in the UI
        function displayPackages(packages) {
            const container = document.getElementById('packages-container');
            container.innerHTML = '';
            
            packages.forEach(pkg => {
                const card = document.createElement('div');
                card.className = 'package-card';
                card.onclick = () => selectPackage(pkg.id);
                
                let duration = '';
                if (pkg.duration) {
                    // Format duration properly
                    duration = `${pkg.duration} ${formatDurationUnit(pkg.durationUnit, pkg.duration)}`;
                }
                
                let dataLimit = '';
                if (pkg.dataLimit) {
                    // Format data limit properly
                    dataLimit = `${formatDataSize(pkg.dataLimit, pkg.dataLimitUnit)}`;
                }
                
                card.innerHTML = `
                    <h3>${pkg.name}</h3>
                    ${pkg.description ? `<p class="description">${pkg.description}</p>` : ''}
                    <div class="package-details">
                        <p><strong>Speed:</strong> ${pkg.downloadSpeed} Mbps</p>
                        ${duration ? `<p><strong>Duration:</strong> ${duration}</p>` : ''}
                        ${dataLimit ? `<p><strong>Data:</strong> ${dataLimit}</p>` : ''}
                        <p class="price">KES ${pkg.price}</p>
                    </div>
                    <button class="select-btn">Select</button>
                `;
                
                container.appendChild(card);
            });
        }

        // Format duration unit (singular/plural)
        function formatDurationUnit(unit, value) {
            if (value === 1) {
                // Convert plural to singular for value of 1
                if (unit === 'hours') return 'hour';
                if (unit === 'days') return 'day';
                if (unit === 'weeks') return 'week';
                if (unit === 'months') return 'month';
            }
            return unit;
        }

        // Format data size with appropriate units
        function formatDataSize(value, unit) {
            if (unit === 'MB' && value >= 1000) {
                return `${(value/1000).toFixed(1)} GB`;
            }
            return `${value} ${unit}`;
        }

        // Handle package selection
        function selectPackage(packageId) {
            localStorage.setItem('selectedPackageId', packageId);
            document.getElementById('package-selection').style.display = 'none';
            document.getElementById('mpesa-payment').style.display = 'block';
        }

        // Handle Mpesa voucher purchase
        async function purchaseVoucherMpesa() {
            const packageId = localStorage.getItem('selectedPackageId');
            const orgId = getOrgId();
            const phoneInput = document.getElementById('mpesa-phone');
            const phoneNumber = phoneInput.value.trim();
            const errorDiv = document.getElementById('mpesa-error');
            const loadingDiv = document.getElementById('mpesa-loading');
            errorDiv.textContent = '';
            loadingDiv.style.display = 'block';

            if (!phoneNumber) {
                errorDiv.textContent = 'Please enter your Mpesa phone number.';
                loadingDiv.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/api/hotspot/purchase-voucher`, {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({
                        organizationId: orgId,
                        packageId: packageId,
                        phoneNumber: phoneNumber
                    })
                });
                loadingDiv.style.display = 'none';
                if (!response.ok) {
                    const err = await response.json();
                    errorDiv.textContent = err.detail || 'Failed to initiate payment.';
                    return;
                }
                const data = await response.json();
                document.getElementById('mpesa-payment').style.display = 'none';
                document.getElementById('voucher-result').style.display = 'block';
                document.getElementById('voucher-code').textContent = 'Waiting for payment confirmation...';
                document.getElementById('voucher-expiry').textContent = 'Please check your phone to complete the Mpesa payment.';
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = 'Network error. Please try again.';
                console.error('Purchase error:', error);
            }
        }

        // Show voucher entry form
        function showVoucherEntry() {
            document.getElementById('package-selection').style.display = 'none';
            document.getElementById('voucher-entry').style.display = 'block';
        }

        // Add theme toggle functionality
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Fallback to local data if API fails
        function useLocalPackages() {
            console.log('Using local package data');
            window.packagesLoaded = true;
            const localPackages = [
                {
                    id: 'local1',
                    name: '1Hr 10Mbps',
                    description: 'Basic internet access',
                    downloadSpeed: 10,
                    uploadSpeed: 10,
                    duration: 1,
                    durationUnit: 'hours',
                    price: 30
                },
                {
                    id: 'local2',
                    name: 'Daily Package',
                    description: 'High-speed internet access',
                    downloadSpeed: 10,
                    uploadSpeed: 5,
                    duration: 1,
                    durationUnit: 'days',
                    price: 100
                },
                {
                    id: 'local3',
                    name: 'Weekly Package',
                    description: 'Multiple device support',
                    downloadSpeed: 15,
                    uploadSpeed: 8,
                    duration: 7,
                    durationUnit: 'days',
                    dataLimit: 5000,
                    dataLimitUnit: 'MB',
                    price: 500
                }
            ];
            
            displayPackages(localPackages);
        }

        // Initialize the page
        window.onload = function() {
            // Set up UI
            const packageSelection = document.getElementById('package-selection');
            const paymentOptions = document.getElementById('mpesa-payment');
            const voucherResult = document.getElementById('voucher-result');
            const voucherEntry = document.getElementById('voucher-entry');
            const haveVoucherBtn = document.getElementById('have-voucher-btn');
            const themeToggle = document.getElementById('theme-toggle');
            
            // Check if elements exist before manipulating them
            if (packageSelection) packageSelection.style.display = 'block';
            if (paymentOptions) paymentOptions.style.display = 'none';
            if (voucherResult) voucherResult.style.display = 'none';
            if (voucherEntry) voucherEntry.style.display = 'none';
            
            // Add event listeners if elements exist
            if (haveVoucherBtn) {
                haveVoucherBtn.addEventListener('click', showVoucherEntry);
            }
            
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // Theme initialization
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            if (typeof updateThemeIcon === 'function') {
                updateThemeIcon();
            }
            
            // Start loading packages
            fetchPackages();
        };
    </script>
</head>

<body>
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">üåô</span>
    </button>
    
    <div class="ie-fixMinHeight">
        <div class="main">
            <div class="wrap animated fadeIn">
                <div class="logo-area">
                    <div class="logo">NetGN Hotspot</div>
                    <div class="tagline">High-speed internet access</div>
                </div>
                
                <!-- Package Selection Section -->
                <div id="package-selection">
                    <h2>Select an Internet Package</h2>
                    <div id="packages-container">
                        <p>Loading packages...</p>
                    </div>
                    <p class="info">
                        <button id="have-voucher-btn">I already have a voucher</button>
                    </p>
                </div>
                
                <!-- Payment Options Section -->
                <div id="mpesa-payment" style="display: none;">
                    <h2>Pay with Mpesa</h2>
                    <div class="mpesa-form">
                        <label for="mpesa-phone">Mpesa Phone Number:</label>
                        <input type="tel" id="mpesa-phone" placeholder="e.g. 07XXXXXXXX or 2547XXXXXXXX" maxlength="13" />
                        <button onclick="purchaseVoucherMpesa()">Pay &amp; Get Voucher</button>
                        <div id="mpesa-loading" style="display:none; color: #888;">Processing payment, please wait...</div>
                        <div id="mpesa-error" style="color: red;"></div>
                    </div>
                    <p class="info">
                        <button type="button" onclick="document.getElementById('package-selection').style.display='block';document.getElementById('mpesa-payment').style.display='none';">Back</button>
                    </p>
                </div>
                
                <!-- Voucher Result Section -->
                <div id="voucher-result" style="display: none;">
                    <h2>Your Voucher</h2>
                    <div class="voucher-details">
                        <p>Voucher Code: <strong id="voucher-code">CODE123</strong></p>
                        <p>Expires: <span id="voucher-expiry">2023-12-31</span></p>
                    </div>
                    <button onclick="loginWithVoucher()">Connect Now</button>
                </div>
                
                <!-- Voucher Entry Section -->
                <div id="voucher-entry" style="display: none;">
                    <h2>Enter Your Voucher</h2>
                    <form name="login" action="$(link-login-only)" method="post" $(if chap-id) onSubmit="return doLogin()" $(endif)>
                        <input type="hidden" name="dst" value="$(link-orig)" />
                        <input type="hidden" name="popup" value="true" />
                        
                        <label>
                            <img class="ico" src="img/user.svg" alt="#" />
                            <input name="username" type="text" value="$(username)" placeholder="Voucher Code" />
                        </label>

                        <label>
                            <img class="ico" src="img/password.svg" alt="#" />
                            <input name="password" type="password" placeholder="Voucher Code (same as above)" />
                        </label>

                        <input type="submit" value="Connect" />
                        <button type="button" onclick="document.getElementById('package-selection').style.display='block';document.getElementById('voucher-entry').style.display='none';">Back</button>
                    </form>
                </div>
                
                <p class="info bt">Powered by MikroTik RouterOS</p>
            </div>
        </div>
    </div>
</body>

</html>
